<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>blackbox-log</title>

		<style>
			.hidden {
				display: none;
			}
		</style>
	</head>

	<body>
		<input id="upload" type="file" />
		<br />
		<button id="run" type="file">Run</button>

		<p>Memory size: <span id="memory">0</span></p>
		<p>Log count: <span id="log-count">0</span></p>
		<p>
			<label for="log">Log:</label>
			<input id="log" type="number" min="1" disabled />
		</p>
		<p id="log-info" class="hidden">
			Firmware revision: <span id="firmware-revision"></span>
			<br />
			Board info: <span id="board-info"></span>
			<br />
			Craft name: <span id="craft-name"></span>
			<br />
			Events: <span id="event-count"></span>
			<br />
			Main frames: <span id="main-count"></span>
			<br />
			Slow frames: <span id="slow-count"></span>
			<br />
			GPS frames: <span id="gps-count"></span>
			<br />
			GPS home frames: <span id="gps-home-count"></span>
		</p>

		<script async type="module">
			// import Parser from './src/main.ts';
			// const parser = await Parser.init();

			import Parser from './src/slim.ts';
			import wasm from './src/blackbox-log.wasm?url';
			const parser = await Parser.init(wasm);

			let file;

			const upload = document.querySelector('#upload');
			const logNum = document.querySelector('#log');
			const memory = document.querySelector('#memory');

			async function fileHandler() {
				file?.free();
				updateMemory();

				const buffer = await upload.files[0].arrayBuffer();
				const view = new Uint8Array(buffer);
				file = parser.loadFile(view);

				logNum.value = file.logCount > 0 ? 1 : undefined;
				logNum.max = file.logCount;
				document.querySelector('#log-count').innerText = file.logCount;
				logHandler();
			}

			upload.addEventListener('change', fileHandler);
			document.querySelector('#run').addEventListener('click', fileHandler);

			if (upload.files.length > 0) {
				fileHandler();
			}

			let animationHandle;
			function logHandler() {
				const { value } = logNum;
				const logInfo = document.querySelector('#log-info');

				if (value === undefined) {
					logNum.disabled = true;
					logInfo.classList.add('hidden');
					updateMemory();
					return;
				}

				logNum.disabled = false;
				logInfo.classList.remove('hidden');

				const headers = file.parseHeaders(value - 1);
				document.querySelector('#firmware-revision').innerText = headers.firmwareRevision;
				document.querySelector('#board-info').innerText = headers.boardInfo ?? '';
				document.querySelector('#craft-name').innerText = headers.craftName ?? '';
				updateMemory();

				if (animationHandle !== undefined) {
					window.cancelAnimationFrame(animationHandle);
					animationHandle = undefined;
				}

				const dataParser = headers.getDataParser();
				updateCounts(dataParser);
				updateMemory();

				const animation = () => {
					if (dataParser.done) {
						animationHandle = undefined;
						return;
					}

					const start = performance.now();
					let i;
					for (i = 0; i < 2000; i++) {
						dataParser.next();
					}
					const end = performance.now();

					updateCounts(dataParser);
					updateMemory();

					animationHandle = window.requestAnimationFrame(animation);
				};
				animationHandle = window.requestAnimationFrame(animation);
			}

			function updateCounts(parser) {
				const { counts } = parser.stats();
				document.querySelector('#event-count').innerText = counts.event;
				document.querySelector('#main-count').innerText = counts.main;
				document.querySelector('#slow-count').innerText = counts.slow;
				document.querySelector('#gps-count').innerText = counts.gps;
				document.querySelector('#gps-home-count').innerText = counts.gpsHome;
			}

			function updateMemory() {
				if (file) {
					const mib = Math.round((file.memorySize / 1024 / 1024) * 100) / 100;
					memory.innerText = `${mib} MiB`;
				}
			}

			logNum.addEventListener('change', logHandler);
		</script>
	</body>
</html>
